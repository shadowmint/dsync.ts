<head>
    <script src="../bin/dsync.js"></script>
    <script src="bower_components/pixi/bin/pixi.js"></script>
    <script src="bower_components/box2d/box2d.js"></script>
    <script src="example.js"></script>
</head>
<body>

<script>
    var demo = new physics.Demo();
    demo.pixi.start();

    demo.create(10, 400);
    demo.create(50, 400);
    demo.create(80, 400);
    demo.create(110, 400);
    demo.blocks[1].geom[0] = 50;
    demo.blocks[1].geom[4] = 1;
    demo.blocks[1].geom[0] = 100;
    demo.blocks[1].geom[2] = 20;
    demo.blocks[1].geom[0] = 200;
    demo.blocks[1].geom[3] = 20;
    demo.sync.touch(demo.sync.channels.physics);

    var bodies = [];

    var gravity = new Box2D.b2Vec2(0.0, -10.0);
    var world = new Box2D.b2World(gravity, true);

    // Ground
    var bd_ground = new Box2D.b2BodyDef();
    var ground = world.CreateBody(bd_ground);
    var shape0 = new Box2D.b2EdgeShape();
    shape0.Set(new Box2D.b2Vec2(-400, 0), new Box2D.b2Vec2(400.0, -10));
    ground.CreateFixture(shape0, 0.0);

    // Block
    for (var i = 0; i < demo.blocks.length; ++i) {
        var shape = new Box2D.b2PolygonShape();
        shape.SetAsBox(demo.blocks[i].geom[2] / 2, demo.blocks[i].geom[3] / 2);
        shape.SetAsBox(10, 10);
        shape.density = 1;

        var ZERO = new Box2D.b2Vec2(demo.blocks[i].geom[0], demo.blocks[i].geom[1]);

        var bd = new Box2D.b2BodyDef();
        bd.set_type(Box2D.b2_dynamicBody);
        bd.set_position(ZERO);

        var body = world.CreateBody(bd);
        body.CreateFixture(shape, 1);
        bodies.push(body);
        demo.blocks[i].body = body;
    }

    function readObject(b) {
        var body = b.body;
        var bpos = body.GetPosition();
        b.geom[0] = bpos.get_x();
        b.geom[1] = 400 - bpos.get_y();
        b.geom[4] = body.GetAngle();
    }

    var data = {};
    var step = function () {
        var dt = 50;
        world.Step(dt, 2, 2);
        for (var i = 0; i < demo.blocks.length; ++i) {
            var b = demo.blocks[i];
            readObject(b);
        }
        demo.sync.touch(demo.sync.channels.physics);
        setTimeout(step, 50);
    }
    step();
</script>
</body>
